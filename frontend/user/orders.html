<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ƒê∆°n h√†ng - PhoneShop</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <style>
      .table thead th {
        font-weight: bold;
        text-transform: uppercase;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary"
      id="navbar"
    ></nav>
    <div class="container my-5">
      <h2 class="mb-4 text-primary">
        <i class="bi bi-clock-history"></i> L·ªãch s·ª≠ ƒë∆°n h√†ng
      </h2>

      <div class="table-responsive bg-white rounded shadow-sm p-3">
        <table class="table table-hover align-middle" id="orderTable">
          <thead class="table-light">
            <tr>
              <th>M√£ ƒë∆°n</th>
              <th>T·ªïng ti·ªÅn</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ng√†y ƒë·∫∑t</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
      if (!isLoggedIn()) window.location.href = "/login.html";

      function getStatusBadge(status) {
        let color = "";
        switch (status) {
          case "Delivered":
            color = "success";
            break;
          case "Shipping":
            color = "info";
            break;
          case "Confirmed":
            color = "primary";
            break;
          case "Cancelled":
            color = "danger";
            break;
          case "Pending":
          default:
            color = "warning";
            break;
        }
        return `<span class="badge bg-${color} text-uppercase shadow-sm">${status}</span>`;
      }

      async function loadOrders() {
        try {
          const data = await GET("/orders/me");
          const tbody = document.querySelector("#orderTable tbody");
          tbody.innerHTML =
            data.orders
              .map(
                (o) => `
          <tr>
            <td class="fw-bold">${o._id.substring(0, 8)}...</td>
            <td class="text-danger">${o.finalAmount.toLocaleString()}ƒë</td>
            <td>${getStatusBadge(o.status)}</td>
            <td>${new Date(o.createdAt).toLocaleDateString()}</td>
            <td>
              ${
                // üéØ ƒêI·ªÄU CH·ªàNH: N√∫t Thanh to√°n ch·ªâ hi·ªán khi Pending v√† kh√¥ng ph·∫£i COD
                o.status === "Pending" && o.paymentMethod !== "COD"
                  ? `<a href="/user/payment.html?orderId=${o._id}" class="btn btn-sm btn-info me-2 text-white shadow-sm">
                        <i class="bi bi-credit-card"></i> Thanh to√°n
                    </a>` // N√∫t Thanh to√°n
                  : ""
              }
              ${
                o.status === "Pending" || o.status === "Confirmed"
                  ? `<button class="btn btn-sm btn-outline-danger shadow-sm" onclick="cancelOrder('${o._id}')">
                        <i class="bi bi-x-circle"></i> H·ªßy
                    </button>` // N√∫t H·ªßy
                  : ""
              }
            </td>
          </tr>
        `
              )
              .join("") ||
            "<tr><td colspan='5' class='text-center py-4 text-muted'>Ch∆∞a c√≥ ƒë∆°n h√†ng</td></tr>";
        } catch (err) {
          alert("L·ªói t·∫£i ƒë∆°n h√†ng: " + err.message);
        }
      }

      async function cancelOrder(id) {
        if (
          !confirm(
            "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y? Vi·ªác h·ªßy s·∫Ω ho√†n l·∫°i s·∫£n ph·∫©m v√†o kho."
          )
        )
          return;
        const reason = prompt("L√Ω do h·ªßy (Kh√¥ng b·∫Øt bu·ªôc):");

        try {
          await POST(`/orders/${id}/cancel`, { reason });
          alert("H·ªßy th√†nh c√¥ng! Kho ƒë√£ ƒë∆∞·ª£c ho√†n l·∫°i.");
          loadOrders();
        } catch (err) {
          alert(
            "L·ªói h·ªßy ƒë∆°n: " +
              (err.message || "ƒê∆°n h√†ng n√†y kh√¥ng th·ªÉ h·ªßy ƒë∆∞·ª£c n·ªØa.")
          );
        }
      }

      document.addEventListener("DOMContentLoaded", loadOrders);
    </script>
  </body>
</html>
