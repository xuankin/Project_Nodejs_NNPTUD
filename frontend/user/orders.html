<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Đơn hàng - PhoneShop</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary"
      id="navbar"
    ></nav>
    <div class="container my-5">
      <h2>Lịch sử đơn hàng</h2>
      <table class="table" id="orderTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tổng tiền</th>
            <th>Trạng thái</th>
            <th>Ngày</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
      if (!isLoggedIn()) window.location.href = "/login.html";

      async function loadOrders() {
        try {
          const data = await GET("/orders/me");
          const tbody = document.querySelector("#orderTable tbody");
          tbody.innerHTML =
            data.orders
              .map(
                (o) => `
            <tr>
              <td>${o._id}</td>
              <td>${o.finalAmount.toLocaleString()}đ</td>
              <td><span class="badge bg-${
                o.status === "Delivered" ? "success" : "warning"
              }">${o.status}</span></td>
              <td>${new Date(o.createdAt).toLocaleDateString()}</td>
              <td><button class="btn btn-sm btn-danger" onclick="cancelOrder('${
                o._id
              }')">Hủy</button></td>
            </tr>
          `
              )
              .join("") ||
            "<tr><td colspan='5' class='text-center'>Chưa có đơn hàng</td></tr>";
        } catch (err) {
          alert("Lỗi tải đơn hàng: " + err.message);
        }
      }

      // Thay thế hàm cancelOrder(id) trong orders.html

      async function cancelOrder(id) {
        if (
          !confirm(
            "Bạn có chắc chắn muốn hủy đơn hàng này? Việc hủy sẽ hoàn lại sản phẩm vào kho."
          )
        )
          return;
        const reason = prompt("Lý do hủy (Không bắt buộc):");

        try {
          // Endpoint: POST /orders/:id/cancel
          await POST(`/orders/${id}/cancel`, { reason });
          alert("Hủy thành công! Kho đã được hoàn lại.");
          loadOrders();
        } catch (err) {
          alert(
            "Lỗi hủy đơn: " +
              (err.message || "Đơn hàng này không thể hủy được nữa.")
          );
        }
      }

      loadOrders();
    </script>
  </body>
</html>
