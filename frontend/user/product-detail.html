<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chi tiết sản phẩm - PhoneShop</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <style>
      .btn-wishlist.active {
        background-color: var(--bs-danger);
        color: white;
        border-color: var(--bs-danger);
      }
      #productImage {
        height: 450px;
        object-fit: contain;
        background-color: white;
        padding: 15px;
        border: 1px solid #eee;
      }
      .review-card-title {
        color: var(--bs-primary);
      }
      .rating-stars {
        color: #ffc107;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary"
      id="navbar"
    ></nav>
    <div class="container my-5">
      <div class="card shadow-lg border-0 rounded-3 p-4">
        <div class="row g-4">
          <div class="col-md-6">
            <img
              id="productImage"
              src=""
              class="img-fluid rounded shadow-sm"
              alt="Sản phẩm"
            />
          </div>
          <div class="col-md-6">
            <h2 id="productName" class="text-primary fw-bold mb-3"></h2>
            <p
              class="text-danger fs-3 fw-bold border-bottom pb-2"
              id="productPrice"
            ></p>

            <div class="mb-3">
              <span id="productRatingSummary" class="d-block mb-2"></span>
              <p class="text-muted mb-2">
                <i class="bi bi-box-seam"></i> <strong>Tồn kho:</strong>
                <span id="productStock"></span>
              </p>
            </div>

            <p id="productDescription" class="text-muted"></p>

            <div class="mb-4 pt-3 border-top">
              <label class="form-label fw-bold">Số lượng:</label>
              <input
                type="number"
                class="form-control w-25 d-inline-block me-3"
                id="quantity"
                value="1"
                min="1"
              />
            </div>

            <div class="mb-3 d-flex gap-3">
              <button
                class="btn btn-primary btn-lg shadow-sm"
                onclick="addToCart()"
              >
                <i class="bi bi-cart-plus"></i> Thêm vào giỏ
              </button>
              <button
                class="btn btn-success btn-lg shadow-sm"
                onclick="buyNow()"
              >
                <i class="bi bi-bag-check"></i> Mua ngay
              </button>
              <button
                class="btn btn-outline-danger btn-lg btn-wishlist"
                id="wishlistBtn"
                onclick="toggleWishlist()"
              >
                <i class="bi bi-heart"></i> Yêu thích
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-5 pt-3 border-top">
        <h3 class="text-primary">
          <i class="bi bi-chat-dots"></i> Đánh giá sản phẩm
        </h3>
        <div id="reviewsContainer" class="row"></div>

        <div class="card my-4 shadow-sm rounded-3" id="reviewFormCard">
          <div class="card-header bg-primary text-white">
            <h5>Thêm đánh giá của bạn</h5>
          </div>
          <div class="card-body">
            <form id="addReviewForm">
              <div class="mb-3">
                <label for="reviewRating" class="form-label fw-bold"
                  >Đánh giá sao:</label
                >
                <select class="form-select w-auto" id="reviewRating" required>
                  <option value="5">★★★★★</option>
                  <option value="4">★★★★☆</option>
                  <option value="3">★★★☆☆</option>
                  <option value="2">★★☆☆☆</option>
                  <option value="1">★☆☆☆☆</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="reviewComment" class="form-label fw-bold"
                  >Bình luận:</label
                >
                <textarea
                  class="form-control"
                  id="reviewComment"
                  rows="3"
                ></textarea>
              </div>
              <button type="submit" class="btn btn-success shadow-sm">
                Gửi đánh giá
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get("id");
      let product;

      function renderStars(rating) {
        const full = "★".repeat(rating || 0);
        const empty = "☆".repeat(5 - (rating || 0));
        return `<span class="rating-stars">${full}${empty}</span>`;
      }

      async function loadProductDetail() {
        if (!productId) return alert("Không có ID sản phẩm!");
        try {
          product = await GET(`/products/${productId}`);
          if (!product) return alert("Sản phẩm không tồn tại");

          document.getElementById("productImage").src =
            product.images?.[0] || "/assets/img/no-image.png";
          document.getElementById("productName").textContent =
            product.name || "N/A";
          document.getElementById("productPrice").textContent = `${(
            product.price || 0
          ).toLocaleString()}đ`;
          document.getElementById("productDescription").textContent =
            product.description || "Không có mô tả";
          document.getElementById("productStock").textContent =
            product.stock || 0;
          document.getElementById("quantity").max = product.stock || 1;

          // Thêm thông tin đánh giá tổng thể
          document.getElementById("productRatingSummary").innerHTML = `
              ${renderStars(Math.round(product.avgRating))} 
              (${product.reviewCount} đánh giá, ${
            product.wishlistCount
          } yêu thích)
          `;

          await checkWishlist(product.userLiked);
          await loadReviews();
          setupReviewForm();
        } catch (err) {
          alert("Lỗi tải sản phẩm: " + err.message);
        }
      }

      async function loadReviews() {
        try {
          const reviews = await GET(`/reviews/${productId}`);
          const container = document.getElementById("reviewsContainer");
          container.innerHTML =
            reviews.length > 0
              ? reviews
                  .map(
                    (r) => `
              <div class="col-md-6 mb-3">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <h6 class="card-title review-card-title">${
                      r.user?.fullName || "Khách"
                    }</h6>
                    <p class="card-subtitle mb-2">${renderStars(r.rating)}</p>
                    <p class="card-text">${
                      r.comment || "Không có bình luận"
                    }</p>
                    <small class="text-muted">${new Date(
                      r.createdAt || Date.now()
                    ).toLocaleDateString()}</small>
                  </div>
                </div>
              </div>
            `
                  )
                  .join("")
              : "<p class='text-muted'>Chưa có đánh giá nào.</p>";
        } catch (err) {
          console.error("Lỗi load đánh giá:", err);
        }
      }

      async function submitReview(e) {
        e.preventDefault();
        if (!isLoggedIn()) return (window.location.href = "/login.html");

        try {
          const rating = parseInt(
            document.getElementById("reviewRating").value
          );
          const comment = document.getElementById("reviewComment").value.trim();

          await POST("/reviews", { product: productId, rating, comment });

          alert("Cảm ơn bạn đã đánh giá!");
          document.getElementById("addReviewForm").reset();
          loadReviews();
          loadProductDetail(); // Tải lại chi tiết để cập nhật Avg Rating
        } catch (err) {
          alert("Lỗi gửi đánh giá: " + (err.message || "Lỗi không xác định"));
        }
      }

      function setupReviewForm() {
        const form = document.getElementById("addReviewForm");
        const card = document.getElementById("reviewFormCard");

        if (isLoggedIn()) {
          form.addEventListener("submit", submitReview);
          card.style.display = "block";
        } else {
          card.innerHTML = `<div class="card-body text-center text-muted">Vui lòng <a href="/login.html">Đăng nhập</a> để thêm đánh giá.</div>`;
        }
      }

      async function addToCart() {
        if (!isLoggedIn()) return (window.location.href = "/login.html");
        const quantity = parseInt(document.getElementById("quantity").value);
        if (quantity > (product?.stock || 0))
          return alert("Không đủ hàng trong kho!");
        try {
          await POST("/carts", { product: productId, quantity });
          alert("Thêm vào giỏ thành công!");
        } catch (err) {
          alert("Lỗi: " + err.message);
        }
      }

      async function buyNow() {
        await addToCart();
        window.location.href = "/user/cart.html";
      }

      async function toggleWishlist() {
        if (!isLoggedIn()) return (window.location.href = "/login.html");
        const btn = document.getElementById("wishlistBtn");
        const isLiked = btn.classList.contains("active");

        try {
          if (isLiked) {
            await DEL(`/wishlists/${productId}`);
          } else {
            await POST("/wishlists", { product: productId });
          }
          checkWishlist(!isLiked); // Cập nhật trạng thái UI ngay lập tức
        } catch (err) {
          alert("Lỗi: " + err.message);
        }
      }

      async function checkWishlist(isLikedStatusFromProduct = null) {
        if (!isLoggedIn()) return;
        const btn = document.getElementById("wishlistBtn");
        let isLiked = false;

        if (isLikedStatusFromProduct !== null) {
          // Sử dụng dữ liệu đã lấy từ API product detail (tối ưu)
          isLiked = isLikedStatusFromProduct;
        } else {
          // Phải gọi API riêng (dự phòng)
          try {
            const wishlist = await GET("/wishlists/me");
            isLiked = (wishlist?.products || []).some(
              (p) =>
                p?._id === productId ||
                (p && p._id && p._id.toString() === productId)
            );
          } catch (err) {
            console.warn("Could not load wishlist status.");
          }
        }

        if (isLiked) {
          btn.classList.add("active");
          btn.innerHTML = `<i class="bi bi-heart-fill"></i> Đã yêu thích`;
        } else {
          btn.classList.remove("active");
          btn.innerHTML = `<i class="bi bi-heart"></i> Yêu thích`;
        }
      }

      document.addEventListener("DOMContentLoaded", loadProductDetail);
    </script>
  </body>
</html>
