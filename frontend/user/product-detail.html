<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chi tiết sản phẩm - PhoneShop</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary"
      id="navbar"
    ></nav>
    <div class="container my-5">
      <div class="row">
        <div class="col-md-6">
          <img
            id="productImage"
            src=""
            class="img-fluid rounded shadow"
            alt="Sản phẩm"
          />
        </div>
        <div class="col-md-6">
          <h2 id="productName"></h2>
          <p class="text-danger fs-3 fw-bold" id="productPrice"></p>
          <p id="productDescription"></p>
          <p class="text-stock">
            <strong>Tồn kho:</strong> <span id="productStock"></span>
          </p>

          <div class="mb-3">
            <label class="form-label">Số lượng:</label>
            <input
              type="number"
              class="form-control w-25 d-inline-block"
              id="quantity"
              value="1"
              min="1"
            />
          </div>

          <div class="mb-3">
            <button class="btn btn-primary me-2" onclick="addToCart()">
              Thêm vào giỏ
            </button>
            <button class="btn btn-success me-2" onclick="buyNow()">
              Mua ngay
            </button>
            <button
              class="btn btn-outline-danger btn-wishlist"
              id="wishlistBtn"
              onclick="toggleWishlist()"
            >
              Yêu thích
            </button>
          </div>
        </div>
      </div>

      <div class="mt-5">
        <h3>Đánh giá sản phẩm</h3>
        <div id="reviewsContainer" class="row"></div>

        <div class="card my-4" id="reviewFormCard">
          <div class="card-header bg-primary text-white">
            <h5>Thêm đánh giá của bạn</h5>
          </div>
          <div class="card-body">
            <form id="addReviewForm">
              <div class="mb-3">
                <label for="reviewRating" class="form-label"
                  >Đánh giá sao:</label
                >
                <select class="form-select w-auto" id="reviewRating" required>
                  <option value="5">★★★★★</option>
                  <option value="4">★★★★☆</option>
                  <option value="3">★★★☆☆</option>
                  <option value="2">★★☆☆☆</option>
                  <option value="1">★☆☆☆☆</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="reviewComment" class="form-label">Bình luận:</label>
                <textarea
                  class="form-control"
                  id="reviewComment"
                  rows="3"
                ></textarea>
              </div>
              <button type="submit" class="btn btn-success">
                Gửi đánh giá
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get("id");
      let product;

      async function loadProductDetail() {
        if (!productId) return alert("Không có ID sản phẩm!");
        try {
          product = await GET(`/products/${productId}`);
          if (!product) return alert("Sản phẩm không tồn tại");
          document.getElementById("productImage").src =
            product.images?.[0] || "/assets/img/no-image.png";
          document.getElementById("productName").textContent =
            product.name || "N/A";
          document.getElementById("productPrice").textContent = `${(
            product.price || 0
          ).toLocaleString()}đ`;
          document.getElementById("productDescription").textContent =
            product.description || "Không có mô tả";
          document.getElementById("productStock").textContent =
            product.stock || 0;
          document.getElementById("quantity").max = product.stock || 1;

          await checkWishlist();
          await loadReviews();
          setupReviewForm(); // Khởi tạo logic form đánh giá
        } catch (err) {
          alert("Lỗi tải sản phẩm: " + err.message);
        }
      }

      async function loadReviews() {
        try {
          // Endpoint: GET /reviews/:productId
          const reviews = await GET(`/reviews/${productId}`);
          const container = document.getElementById("reviewsContainer");
          container.innerHTML =
            reviews.length > 0
              ? reviews
                  .map(
                    (r) => `
              <div class="col-md-6 mb-3">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title">${
                      r.user?.fullName || "Khách"
                    } - ${"★".repeat(r.rating || 0)}${"☆".repeat(
                      5 - (r.rating || 0)
                    )}</h6>
                    <p class="card-text">${
                      r.comment || "Không có bình luận"
                    }</p>
                    <small class="text-muted">${new Date(
                      r.createdAt || Date.now()
                    ).toLocaleDateString()}</small>
                  </div>
                </div>
              </div>
            `
                  )
                  .join("")
              : "<p class='text-muted'>Chưa có đánh giá nào.</p>";
        } catch (err) {
          console.error("Lỗi load đánh giá:", err);
        }
      }

      // START: Logic Đánh giá mới
      async function submitReview(e) {
        e.preventDefault();
        if (!isLoggedIn()) return (window.location.href = "/login.html");

        try {
          const rating = parseInt(
            document.getElementById("reviewRating").value
          );
          const comment = document.getElementById("reviewComment").value.trim();

          // Endpoint: POST /reviews
          await POST("/reviews", { product: productId, rating, comment });

          alert("Cảm ơn bạn đã đánh giá!");
          document.getElementById("addReviewForm").reset();
          loadReviews();
        } catch (err) {
          alert("Lỗi gửi đánh giá: " + (err.message || "Lỗi không xác định"));
        }
      }

      function setupReviewForm() {
        const form = document.getElementById("addReviewForm");
        const card = document.getElementById("reviewFormCard");

        if (isLoggedIn()) {
          form.addEventListener("submit", submitReview);
          card.style.display = "block";
        } else {
          card.innerHTML = `<div class="card-body text-center text-muted">Vui lòng <a href="/login.html">Đăng nhập</a> để thêm đánh giá.</div>`;
        }
      }
      // END: Logic Đánh giá mới

      async function addToCart() {
        if (!isLoggedIn()) return (window.location.href = "/login.html");
        const quantity = parseInt(document.getElementById("quantity").value);
        if (quantity > (product?.stock || 0))
          return alert("Không đủ hàng trong kho!");
        try {
          // Endpoint: POST /carts
          await POST("/carts", { product: productId, quantity });
          alert("Thêm vào giỏ thành công!");
        } catch (err) {
          alert("Lỗi: " + err.message);
        }
      }

      async function buyNow() {
        await addToCart();
        window.location.href = "/user/cart.html";
      }

      async function toggleWishlist() {
        if (!isLoggedIn()) return (window.location.href = "/login.html");
        const btn = document.getElementById("wishlistBtn");
        const isLiked = btn.classList.contains("active");

        try {
          if (isLiked) {
            // SỬA LỖI ENDPOINT: DEL /wishlists/:id
            await DEL(`/wishlists/${productId}`);
            btn.classList.remove("active");
            btn.innerHTML = "Yêu thích";
          } else {
            // SỬA LỖI ENDPOINT: POST /wishlists
            await POST("/wishlists", { product: productId });
            btn.classList.add("active");
            btn.innerHTML = "Đã yêu thích";
          }
        } catch (err) {
          alert("Lỗi: " + err.message);
        }
      }

      async function checkWishlist() {
        if (!isLoggedIn()) return;
        try {
          // Endpoint: GET /wishlists/me
          const wishlist = await GET("/wishlists/me");
          // Kiểm tra xem sản phẩm có trong danh sách yêu thích không
          const isLiked = (wishlist?.products || []).some(
            (p) => p?._id === productId
          );
          const btn = document.getElementById("wishlistBtn");
          if (isLiked) {
            btn.classList.add("active");
            btn.innerHTML = "Đã yêu thích";
          }
        } catch (err) {
          // Bỏ qua lỗi nếu không load được wishlist (ví dụ: chưa có danh sách)
        }
      }

      document.addEventListener("DOMContentLoaded", loadProductDetail);
    </script>
  </body>
</html>
