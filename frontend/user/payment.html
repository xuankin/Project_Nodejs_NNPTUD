<!DOCTYPE html>
<html lang="vi">
  <body>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
      if (!isLoggedIn()) window.location.href = "/login.html";

      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get("orderId");

      async function loadOrder() {
        if (!orderId) return alert("Kh√¥ng c√≥ ID ƒë∆°n h√†ng!");
        try {
          const order = await GET(`/orders/${orderId}`);
          document.getElementById(
            "orderId"
          ).textContent = `M√£ ƒë∆°n: ${order._id}`;
          document.getElementById(
            "finalAmount"
          ).textContent = `T·ªïng ti·ªÅn: ${order.finalAmount.toLocaleString()}ƒë`;

          // üéØ CH·ªàNH S·ª¨A: ƒê·ªìng b·ªô ph∆∞∆°ng th·ª©c thanh to√°n ƒë√£ ch·ªçn
          const paymentMethodSelect = document.getElementById("paymentMethod");
          if (order.paymentMethod) {
            paymentMethodSelect.value = order.paymentMethod;
          }
        } catch (err) {
          alert("L·ªói t·∫£i ƒë∆°n h√†ng: " + err.message);
        }
      }

      async function confirmPayment() {
        const method = document.getElementById("paymentMethod").value;
        const amount = parseFloat(
          document
            .getElementById("finalAmount")
            .textContent.replace(/[^\d]/g, "")
        );
        try {
          // Endpoint: POST /payments
          await POST("/payments", {
            order: orderId,
            method,
            amount,
          });
          alert("Thanh to√°n th√†nh c√¥ng!");
          window.location.href = "/user/orders.html";
        } catch (err) {
          alert("Thanh to√°n th·∫•t b·∫°i: " + err.message);
        }
      }

      document.addEventListener("DOMContentLoaded", loadOrder);
    </script>
  </body>
</html>
