<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Th√¥ng b√°o - PhoneShop</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary"
      id="navbar"
    ></nav>
    <div class="container my-5">
      <h2 class="mb-4">üîî Th√¥ng b√°o c·ªßa b·∫°n</h2>

      <div class="d-flex justify-content-end mb-3">
        <button
          class="btn btn-sm btn-outline-secondary me-2"
          onclick="loadNotifications()"
        >
          <i class="bi bi-arrow-clockwise"></i> T·∫£i l·∫°i
        </button>
        <button
          class="btn btn-sm btn-info"
          id="markAllReadBtn"
          onclick="markAllAsRead()"
        >
          <i class="bi bi-check-all"></i> ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
        </button>
      </div>

      <div id="notificationsContainer" class="list-group">
        <div class="text-center py-5 text-muted">ƒêang t·∫£i th√¥ng b√°o...</div>
      </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
      if (!isLoggedIn()) window.location.href = "/login.html";

      function getNotiClass(type, isRead) {
        let base =
          "list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2 shadow-sm border border-start-0 border-end-0 border-3";
        let readClass = isRead
          ? "list-group-item-light text-muted"
          : "bg-white border-primary";

        if (type === "ORDER") readClass += " border-warning";
        if (type === "SYSTEM") readClass += " border-danger";
        if (type === "PROMOTION") readClass += " border-success";

        return `${base} ${readClass}`;
      }

      function getNotiIcon(type) {
        switch (type) {
          case "ORDER":
            return '<i class="bi bi-box-seam text-warning"></i>';
          case "PROMOTION":
            return '<i class="bi bi-gift text-success"></i>';
          case "SYSTEM":
          default:
            return '<i class="bi bi-info-circle text-danger"></i>';
        }
      }

      async function loadNotifications() {
        try {
          const notifications = await GET("/notifications/me");
          const container = document.getElementById("notificationsContainer");

          if (!notifications || notifications.length === 0) {
            container.innerHTML = `<div class="text-center py-5 text-muted"><i class="bi bi-bell-slash fs-1"></i><p>B·∫°n kh√¥ng c√≥ th√¥ng b√°o n√†o.</p></div>`;
            document.getElementById("markAllReadBtn").style.display = "none";
            return;
          }
          document.getElementById("markAllReadBtn").style.display = "block";

          container.innerHTML = notifications
            .map(
              (n) => `
                <div class="${getNotiClass(n.type, n.isRead)}" id="noti-${
                n._id
              }">
                  <div>
                    ${getNotiIcon(n.type)}
                    <strong class="ms-2">${n.message}</strong>
                    <small class="text-muted ms-3">${new Date(
                      n.createdAt
                    ).toLocaleString()}</small>
                  </div>
                  <div class="d-flex align-items-center">
                    ${
                      !n.isRead
                        ? `<span class="badge bg-primary me-2">M·ªõi</span>
                         <button class="btn btn-sm btn-outline-info" onclick="markAsRead('${n._id}')">
                            ƒê√°nh d·∫•u ƒë·ªçc
                         </button>`
                        : `<span class="badge bg-secondary">ƒê√£ ƒë·ªçc</span>`
                    }
                  </div>
                </div>
            `
            )
            .join("");
        } catch (err) {
          console.error("L·ªói load th√¥ng b√°o:", err);
          alert("Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o: " + err.message);
        }
      }

      async function markAsRead(id) {
        try {
          await PUT(`/notifications/${id}/read`, {});
          const notiElement = document.getElementById(`noti-${id}`);
          if (notiElement) {
            // C·∫≠p nh·∫≠t giao di·ªán m√† kh√¥ng c·∫ßn reload to√†n b·ªô
            notiElement.classList.remove("bg-white", "border-primary");
            notiElement.classList.add("list-group-item-light", "text-muted");

            // X√≥a n√∫t "ƒê√°nh d·∫•u ƒë·ªçc" v√† badge "M·ªõi"
            const newContent = notiElement.innerHTML.replace(
              /<span class="badge bg-primary me-2">M·ªõi<\/span>[\s\S]*?<\/button>/,
              `<span class="badge bg-secondary">ƒê√£ ƒë·ªçc</span>`
            );
            notiElement.innerHTML = newContent;
          }
          // T√πy ch·ªçn: loadNotifications();
        } catch (err) {
          alert("L·ªói ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc: " + err.message);
        }
      }

      async function markAllAsRead() {
        if (
          !confirm(
            "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o l√† ƒë√£ ƒë·ªçc kh√¥ng?"
          )
        )
          return;
        try {
          const notifications = await GET("/notifications/me");
          // G·ª≠i nhi·ªÅu request PUT, c√≥ th·ªÉ t·ªëi ∆∞u b·∫±ng 1 API call n·∫øu backend h·ªó tr·ª£
          const unreadIds = notifications
            .filter((n) => !n.isRead)
            .map((n) => n._id);

          for (const id of unreadIds) {
            await markAsRead(id);
          }
          alert("ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o ch∆∞a ƒë·ªçc.");
          loadNotifications();
        } catch (err) {
          alert("L·ªói khi ƒë√°nh d·∫•u t·∫•t c·∫£: " + err.message);
        }
      }

      document.addEventListener("DOMContentLoaded", loadNotifications);
    </script>
  </body>
</html>
