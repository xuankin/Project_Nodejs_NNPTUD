<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Th√¥ng b√°o - PhoneShop</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      .list-group-item {
        border-radius: 0.75rem !important; /* Bo tr√≤n */
        border: none !important;
        transition: transform 0.2s;
      }
      .list-group-item:hover {
        transform: translateY(-2px);
      }
      .border-style-custom {
        border-left: 5px solid;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary"
      id="navbar"
    ></nav>
    <div class="container my-5">
      <h2 class="mb-4 text-primary">üîî Th√¥ng b√°o c·ªßa b·∫°n</h2>

      <div class="d-flex justify-content-end mb-3">
        <button
          class="btn btn-sm btn-outline-primary me-2"
          onclick="loadNotifications()"
        >
          <i class="bi bi-arrow-clockwise"></i> T·∫£i l·∫°i
        </button>
        <button
          class="btn btn-sm btn-info text-white shadow-sm"
          id="markAllReadBtn"
          onclick="markAllAsRead()"
        >
          <i class="bi bi-check-all"></i> ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
        </button>
      </div>

      <div id="notificationsContainer" class="list-group">
        <div class="text-center py-5 text-muted">ƒêang t·∫£i th√¥ng b√°o...</div>
      </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
      if (!isLoggedIn()) window.location.href = "/login.html";

      function getNotiClass(type, isRead) {
        let base =
          "list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-3 shadow-sm border-style-custom";
        let readClass = isRead
          ? "list-group-item-light text-muted"
          : "bg-white";

        let borderClass = "";
        if (type === "ORDER") borderClass = "border-warning";
        if (type === "SYSTEM") borderClass = "border-danger";
        if (type === "PROMOTION") borderClass = "border-success";
        if (!isRead) borderClass = "border-primary"; // Th√¥ng b√°o ch∆∞a ƒë·ªçc lu√¥n n·ªïi b·∫≠t

        return `${base} ${readClass} ${borderClass}`;
      }

      function getNotiIcon(type) {
        switch (type) {
          case "ORDER":
            return '<i class="bi bi-box-seam text-warning fs-5"></i>';
          case "PROMOTION":
            return '<i class="bi bi-gift text-success fs-5"></i>';
          case "SYSTEM":
          default:
            return '<i class="bi bi-info-circle text-danger fs-5"></i>';
        }
      }

      async function loadNotifications() {
        try {
          const notifications = await GET("/notifications/me");
          const container = document.getElementById("notificationsContainer");

          if (!notifications || notifications.length === 0) {
            container.innerHTML = `<div class="text-center py-5 text-muted"><i class="bi bi-bell-slash fs-1"></i><p>B·∫°n kh√¥ng c√≥ th√¥ng b√°o n√†o.</p></div>`;
            document.getElementById("markAllReadBtn").style.display = "none";
            return;
          }
          document.getElementById("markAllReadBtn").style.display = "block";

          container.innerHTML = notifications
            .map(
              (n) => `
                <div class="${getNotiClass(n.type, n.isRead)}" id="noti-${
                n._id
              }">
                  <div class="d-flex align-items-start">
                    ${getNotiIcon(n.type)}
                    <div class="ms-3">
                        <strong class="${
                          n.isRead ? "text-muted" : "text-dark"
                        }">${n.message}</strong>
                        <small class="text-muted d-block mt-1">
                            ${new Date(n.createdAt).toLocaleString()}
                        </small>
                    </div>
                  </div>
                  <div class="d-flex align-items-center flex-shrink-0">
                    ${
                      !n.isRead
                        ? `<span class="badge bg-primary me-3 p-2">M·ªöI</span>
                         <button class="btn btn-sm btn-outline-primary" onclick="markAsRead('${n._id}')">
                            <i class="bi bi-check-lg"></i> ƒê√£ ƒë·ªçc
                         </button>`
                        : `<span class="badge bg-secondary p-2">ƒê√£ ƒë·ªçc</span>`
                    }
                  </div>
                </div>
            `
            )
            .join("");
        } catch (err) {
          console.error("L·ªói load th√¥ng b√°o:", err);
          alert("Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o: " + err.message);
        }
      }

      async function markAsRead(id) {
        try {
          await PUT(`/notifications/${id}/read`, {});
          // G·ªçi l·∫°i loadNotifications ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán to√†n b·ªô (an to√†n h∆°n)
          loadNotifications();
        } catch (err) {
          alert("L·ªói ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc: " + err.message);
        }
      }

      async function markAllAsRead() {
        if (
          !confirm(
            "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o l√† ƒë√£ ƒë·ªçc kh√¥ng?"
          )
        )
          return;
        try {
          const notifications = await GET("/notifications/me");
          const unreadIds = notifications
            .filter((n) => !n.isRead)
            .map((n) => n._id);

          for (const id of unreadIds) {
            await PUT(`/notifications/${id}/read`, {}); // G·ª≠i t·ª´ng request
          }
          alert("ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o ch∆∞a ƒë·ªçc.");
          loadNotifications();
        } catch (err) {
          alert("L·ªói khi ƒë√°nh d·∫•u t·∫•t c·∫£: " + err.message);
        }
      }

      document.addEventListener("DOMContentLoaded", loadNotifications);
    </script>
  </body>
</html>
