<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>V·ªã tr√≠ C·ª≠a h√†ng - PhoneShop</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css"
      type="text/css"
    />

    <style>
      :root {
        --bs-border-radius: 0.75rem;
      }
      #map {
        height: 500px;
        border-radius: var(--bs-border-radius);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .store-list-item {
        cursor: pointer;
        transition: background-color 0.2s;
        border-radius: 0.5rem;
        border-left: 3px solid transparent;
      }
      .store-list-item.active,
      .store-list-item:hover {
        background-color: #f0f8ff;
        border-left-color: var(--bs-primary);
      }
      .store-list-item i {
        width: 20px;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary"
      id="navbar"
    ></nav>
    <div class="container my-5">
      <h2 class="mb-4 text-primary">
        <i class="fas fa-map-marker-alt me-2"></i> H·ªá th·ªëng C·ª≠a h√†ng t·∫°i TP. HCM
      </h2>

      <div class="row g-4">
        <div class="col-md-4">
          <div class="list-group shadow-sm" id="storeListContainer">
            <h5 class="list-group-item active rounded-top-3">
              Ch·ªçn c·ª≠a h√†ng g·∫ßn b·∫°n
            </h5>
            <div id="store-list-content">
              <div class="text-center py-5 text-muted">ƒêang t·∫£i v·ªã tr√≠...</div>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <div id="map"></div>
          <div
            class="alert alert-info mt-3"
            id="directionsLink"
            style="display: none"
          ></div>
        </div>
      </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>

    <script src="../assets/js/config.js"></script>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>

    <script>
      // üîë ƒê·ªåC KEY T·ª™ ENV_CONFIG
      const MAPBOX_TOKEN = ENV_CONFIG.MAPBOX_TOKEN;
      mapboxgl.accessToken = MAPBOX_TOKEN;

      // Bi·∫øn l∆∞u t·ªça ƒë·ªô th·ª±c t·∫ø c·ªßa ng∆∞·ªùi d√πng [Lng, Lat]
      let userCoordinates = null;

      const stores = [
        {
          id: 1,
          name: "PhoneShop Qu·∫≠n 1 (Tr·ª• s·ªü ch√≠nh)",
          address: "123 ƒê∆∞·ªùng Nguy·ªÖn Hu·ªá, Ph∆∞·ªùng B·∫øn Ngh√©, Qu·∫≠n 1, TP.HCM",
          phone: "028 1234 5678",
          coords: [106.7025, 10.7735],
        },
        {
          id: 2,
          name: "PhoneShop Qu·∫≠n 3",
          address: "456 V√µ VƒÉn T·∫ßn, Ph∆∞·ªùng 6, Qu·∫≠n 3, TP.HCM",
          phone: "028 9876 5432",
          coords: [106.683, 10.776],
        },
        {
          id: 3,
          name: "PhoneShop Th·ªß ƒê·ª©c",
          address: "789 ƒê∆∞·ªùng Kha V·∫°n C√¢n, Ph∆∞·ªùng Linh Chi·ªÉu, TP. Th·ªß ƒê·ª©c",
          phone: "028 3333 4444",
          coords: [106.745, 10.849],
        },
        {
          id: 4,
          name: "PhoneShop Qu·∫≠n 7",
          address: "101 Nguy·ªÖn Th·ªã Th·∫≠p, Ph∆∞·ªùng T√¢n Quy, Qu·∫≠n 7, TP.HCM",
          phone: "028 5555 6666",
          coords: [106.711, 10.743],
        },
      ];

      let map;
      let directions;

      /**
       * Kh·ªüi t·∫°o b·∫£n ƒë·ªì Mapbox v√† Geolocation Control.
       */
      function initializeMap() {
        map = new mapboxgl.Map({
          container: "map",
          style: "mapbox://styles/mapbox/streets-v12",
          center: [106.701, 10.774],
          zoom: 12,
        });

        // Th√™m Geolocation Control (ƒê·ªãnh v·ªã ng∆∞·ªùi d√πng)
        const geoLocateControl = new mapboxgl.GeolocateControl({
          positionOptions: { enableHighAccuracy: true },
          trackUserLocation: true,
          showUserHeading: true,
        });

        map.addControl(geoLocateControl);

        // L·∫Øng nghe s·ª± ki·ªán v·ªã tr√≠ ƒë∆∞·ª£c t√¨m th·∫•y
        geoLocateControl.on("geolocate", (e) => {
          userCoordinates = [e.coords.longitude, e.coords.latitude];
          console.log("V·ªã tr√≠ ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t:", userCoordinates);

          // N·∫øu c√≥ c·ª≠a h√†ng ƒëang ƒë∆∞·ª£c ch·ªçn, t·ª± ƒë·ªông t√≠nh l·∫°i ƒë∆∞·ªùng ƒëi
          const activeEl = document.querySelector(".store-list-item.active");
          if (activeEl) {
            const idMatch = activeEl.getAttribute("onclick").match(/\((\d+)\)/);
            if (idMatch && idMatch[1]) {
              selectStore(parseInt(idMatch[1]));
            }
          }
        });

        // Th√™m Directions Control (Ch·ªâ ƒë∆∞·ªùng)
        directions = new MapboxDirections({
          accessToken: MAPBOX_TOKEN, // S·ª≠ d·ª•ng bi·∫øn ƒë√£ l·∫•y t·ª´ config
          unit: "metric",
          profile: "mapbox/driving",
          controls: { instructions: true, profileSwitcher: false },
          interactive: false,
        });

        map.addControl(directions, "top-left");
      }

      /**
       * HI·ªÇN TH·ªä DANH S√ÅCH C·ª¨A H√ÄNG
       */
      function renderStoreList() {
        const listContent = document.getElementById("store-list-content");
        listContent.innerHTML = stores
          .map(
            (store) => `
            <div class="list-group-item store-list-item p-3" onclick="selectStore(${store.id})">
                <h6 class="text-primary mb-1">${store.name}</h6>
                <p class="mb-0 small text-muted"><i class="fas fa-location-arrow me-2"></i> ${store.address}</p>
                <p class="mb-0 small text-success"><i class="fas fa-phone me-2"></i> ${store.phone}</p>
            </div>
          `
          )
          .join("");
      }

      /**
       * X·ª≠ l√Ω ch·ªçn c·ª≠a h√†ng, t√≠nh to√°n v√† v·∫Ω ch·ªâ ƒë∆∞·ªùng.
       */
      function selectStore(id) {
        // 1. Highlight m·ª•c ƒë∆∞·ª£c ch·ªçn
        document
          .querySelectorAll(".store-list-item")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelector(`.list-group-item[onclick="selectStore(${id})"]`)
          .classList.add("active");

        const selectedStore = stores.find((s) => s.id === id);
        const storeName = selectedStore.name;

        // ‚ö†Ô∏è KI·ªÇM TRA V·ªä TR√ç NG∆Ø·ªúI D√ôNG
        if (!userCoordinates) {
          directions.clear();
          document.getElementById("directionsLink").style.display = "block";
          document.getElementById("directionsLink").className =
            "alert alert-warning mt-3";
          document.getElementById("directionsLink").innerHTML = `
                 <i class="fas fa-exclamation-triangle"></i> 
                 Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠ v√† b·∫•m v√†o bi·ªÉu t∆∞·ª£ng ƒë·ªãnh v·ªã <i class="fas fa-location-arrow"></i> tr√™n b·∫£n ƒë·ªì ƒë·ªÉ x√°c ƒë·ªãnh ƒëi·ªÉm xu·∫•t ph√°t!
              `;
          return;
        }

        // 2. T√≠nh to√°n v√† v·∫Ω ƒë∆∞·ªùng ƒëi
        directions.setOrigin(userCoordinates);
        directions.setDestination(selectedStore.coords);

        // 3. C·∫≠p nh·∫≠t th√¥ng b√°o
        document.getElementById("directionsLink").className =
          "alert alert-info mt-3";
        document.getElementById("directionsLink").style.display = "block";
        document.getElementById("directionsLink").innerHTML = `
             <i class="fas fa-route"></i> 
             **ƒê∆∞·ªùng ƒëi** t·ª´ v·ªã tr√≠ c·ªßa b·∫°n ƒë·∫øn <b>${storeName}</b> ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã tr√™n b·∫£n ƒë·ªì.
          `;
      }

      document.addEventListener("DOMContentLoaded", () => {
        renderStoreList();
        initializeMap();
      });
    </script>
  </body>
</html>
