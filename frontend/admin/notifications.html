<!DOCTYPE html>
<html lang="vi">
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary"
      id="navbar"
    ></nav>
    <div class="container my-5">
      <h2>üì¢ G·ª≠i Th√¥ng b√°o</h2>

      <div class="card shadow-sm">
        <div class="card-body">
          <form id="notificationForm">
            <div class="mb-3">
              <label for="recipient" class="form-label">Ng∆∞·ªùi nh·∫≠n</label>
              <select class="form-select" id="recipientId" required>
                <option value="ALL">T·∫•t c·∫£ ng∆∞·ªùi d√πng</option>
              </select>
              <small class="form-text text-muted"
                >Ch·ªçn 'T·∫•t c·∫£ ng∆∞·ªùi d√πng' ho·∫∑c m·ªôt ID User c·ª• th·ªÉ.</small
              >
            </div>

            <div class="mb-3">
              <label for="type" class="form-label">Lo·∫°i th√¥ng b√°o</label>
              <select class="form-select" id="type" required>
                <option value="System">H·ªá th·ªëng (SYSTEM)</option>
                <option value="Order">ƒê∆°n h√†ng (ORDER)</option>
                <option value="Promotion">Khuy·∫øn m√£i (PROMOTION)</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="message" class="form-label">N·ªôi dung th√¥ng b√°o</label>
              <textarea
                class="form-control"
                id="message"
                rows="3"
                required
              ></textarea>
            </div>

            <button type="submit" class="btn btn-primary">G·ª≠i Th√¥ng b√°o</button>
          </form>
        </div>
      </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/admin.js"></script>
    <script>
      if (!isLoggedIn() || getRole() !== "ADMIN") window.location.href = "/";

      async function loadUsersForRecipient() {
        try {
          // L·∫•y danh s√°ch users (Admin c·∫ßn route GET /users)
          const users = await GET("/users");
          const select = document.getElementById("recipientId");

          // Gi·ªØ l·∫°i option ALL
          select.innerHTML = '<option value="ALL">T·∫•t c·∫£ ng∆∞·ªùi d√πng</option>';

          users.forEach((user) => {
            const option = document.createElement("option");
            option.value = user._id;
            option.textContent = `${user.fullName} (${user.email}) - ID: ${user._id}`;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("L·ªói t·∫£i danh s√°ch ng∆∞·ªùi d√πng:", err);
        }
      }

      document.getElementById("notificationForm").onsubmit = async (e) => {
        e.preventDefault();

        const recipientId = document.getElementById("recipientId").value;
        const type = document.getElementById("type").value;
        const message = document.getElementById("message").value.trim();

        try {
          const body = { message, type, recipientId };
          await POST("/notifications", body);

          alert(
            `Th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng ƒë·∫øn: ${
              recipientId === "ALL" ? "T·∫•t c·∫£" : "Ng∆∞·ªùi d√πng ID: " + recipientId
            }`
          );
          document.getElementById("notificationForm").reset();
        } catch (err) {
          alert("L·ªói g·ª≠i th√¥ng b√°o: " + err.message);
        }
      };

      document.addEventListener("DOMContentLoaded", loadUsersForRecipient);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
