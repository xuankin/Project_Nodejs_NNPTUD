<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" id="navbar"></nav>
    <div class="container my-5">
      <h2>Th·ªëng k√™ H·ªá th·ªëng Chuy√™n nghi·ªáp</h2>

      <div class="row g-4 mb-4">
        <div class="col-md-3">
          <div class="card text-white bg-warning">
            <div class="card-body">
              <h5 class="card-title">üí∞ T·ªïng Doanh thu</h5>
              <h3 id="totalRevenue">0ƒë</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-primary">
            <div class="card-body">
              <h5 class="card-title">üì¶ T·ªïng ƒê∆°n h√†ng</h5>
              <h3 id="totalOrders">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-info">
            <div class="card-body">
              <h5 class="card-title">üì± T·ªïng S·∫£n ph·∫©m</h5>
              <h3 id="totalProducts">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-success">
            <div class="card-body">
              <h5 class="card-title">üë§ T·ªïng Ng∆∞·ªùi d√πng</h5>
              <h3 id="totalUsers">0</h3>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mb-4">
        <div class="col-md-4">
          <div class="card shadow">
            <div class="card-header bg-light">
              <h5 class="mb-0">Tr·∫°ng th√°i ƒê∆°n h√†ng</h5>
            </div>
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between">
                <span>ƒêang ch·ªù x·ª≠ l√Ω (Pending)</span>
                <span class="badge bg-secondary" id="countPending">0</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>ƒê√£ giao h√†ng (Delivered)</span>
                <span class="badge bg-success" id="countDelivered">0</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>ƒê√£ h·ªßy (Cancelled)</span>
                <span class="badge bg-danger" id="countCancelled">0</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>ƒêang v·∫≠n chuy·ªÉn (Shipping)</span>
                <span class="badge bg-primary" id="countShipping">0</span>
              </li>
            </ul>
          </div>
        </div>

        <div class="col-md-8">
          <div class="card shadow h-100">
            <div class="card-header bg-light">
              <h5 class="mb-0">Ph√¢n ph·ªëi Tr·∫°ng th√°i ƒê∆°n h√†ng</h5>
            </div>
            <div
              class="card-body d-flex justify-content-center align-items-center"
            >
              <div style="max-width: 500px">
                <canvas id="orderStatusChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
      if (getRole() !== "ADMIN") {
        alert("B·∫°n kh√¥ng c√≥ quy·ªÅn!");
        window.location.href = "/";
      }

      async function loadStats() {
        try {
          // L·∫•y d·ªØ li·ªáu t·ª´ 3 API: S·∫£n ph·∫©m, ƒê∆°n h√†ng, Ng∆∞·ªùi d√πng
          const [products, ordersData, users] = await Promise.all([
            GET("/products"),
            GET("/orders"), // API tr·∫£ v·ªÅ { orders: [], pagination: {} }
            GET("/users"), // Gi·∫£ ƒë·ªãnh API GET /users ƒë√£ c√≥
          ]);

          const orders = ordersData?.orders || [];
          const usersCount = users.length || 0;

          // 1. T√≠nh to√°n Doanh thu v√† ƒê∆°n h√†ng
          const revenue = orders.reduce(
            (sum, o) => sum + (o.finalAmount || 0),
            0
          );
          document.getElementById("totalRevenue").textContent =
            revenue.toLocaleString() + "ƒë";
          document.getElementById("totalOrders").textContent = orders.length;
          document.getElementById("totalProducts").textContent =
            products.length;
          document.getElementById("totalUsers").textContent = usersCount;

          // 2. Ph√¢n lo·∫°i Tr·∫°ng th√°i ƒê∆°n h√†ng
          const statusCounts = orders.reduce((acc, order) => {
            const status = order.status || "Unknown";
            acc[status] = (acc[status] || 0) + 1;
            return acc;
          }, {});

          document.getElementById("countPending").textContent =
            statusCounts.Pending || 0;
          document.getElementById("countDelivered").textContent =
            statusCounts.Delivered || 0;
          document.getElementById("countCancelled").textContent =
            statusCounts.Cancelled || 0;
          document.getElementById("countShipping").textContent =
            statusCounts.Shipping || 0;

          // 3. V·∫Ω Bi·ªÉu ƒë·ªì
          renderOrderStatusChart(statusCounts);
        } catch (err) {
          alert("L·ªói t·∫£i th·ªëng k√™: " + err.message);
        }
      }

      function renderOrderStatusChart(counts) {
        const ctx = document.getElementById("orderStatusChart");

        new Chart(ctx, {
          type: "doughnut", // Bi·ªÉu ƒë·ªì h√¨nh tr√≤n
          data: {
            labels: ["ƒê√£ giao", "ƒêang ch·ªù", "ƒêang v·∫≠n chuy·ªÉn", "ƒê√£ h·ªßy"],
            datasets: [
              {
                label: "S·ªë l∆∞·ª£ng ƒë∆°n h√†ng",
                data: [
                  counts.Delivered || 0,
                  counts.Pending || 0,
                  counts.Shipping || 0,
                  counts.Cancelled || 0,
                ],
                backgroundColor: [
                  "#198754", // success
                  "#6c757d", // secondary
                  "#0d6efd", // primary
                  "#dc3545", // danger
                ],
                hoverOffset: 4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
              },
              title: {
                display: false,
              },
            },
          },
        });
      }

      document.addEventListener("DOMContentLoaded", loadStats);
    </script>
  </body>
</html>
