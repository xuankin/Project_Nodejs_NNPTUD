<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Qu·∫£n l√Ω Danh m·ª•c</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" id="navbar"></nav>

    <div class="container my-4">
      <h2 class="text-dark mb-4">
        <i class="fas fa-list-alt me-2"></i> Qu·∫£n l√Ω Danh m·ª•c S·∫£n ph·∫©m
      </h2>

      <button
        class="btn btn-primary mb-3"
        data-bs-toggle="modal"
        data-bs-target="#categoryModal"
        onclick="resetForm()"
      >
        <i class="fas fa-plus me-1"></i> Th√™m Danh m·ª•c
      </button>

      <div class="card shadow-sm">
        <div class="card-body">
          <table class="table table-striped" id="categoryTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>T√™n Danh m·ª•c</th>
                <th>Danh m·ª•c cha</th>
                <th>M√¥ t·∫£</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="categoryList">
              <tr>
                <td colspan="5" class="text-center text-muted">
                  ƒêang t·∫£i d·ªØ li·ªáu...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="categoryModal"
      tabindex="-1"
      aria-labelledby="categoryModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="categoryModalLabel">
              T·∫°o Danh m·ª•c m·ªõi
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="categoryForm">
              <div class="mb-3">
                <label for="name" class="form-label">T√™n Danh m·ª•c</label>
                <input type="text" class="form-control" id="name" required />
              </div>
              <div class="mb-3">
                <label for="description" class="form-label">M√¥ t·∫£</label>
                <textarea
                  class="form-control"
                  id="description"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="imageURL" class="form-label">URL H√¨nh ·∫£nh</label>
                <input type="url" class="form-control" id="imageURL" />
              </div>
              <div class="mb-3">
                <label for="parentCategory" class="form-label"
                  >Danh m·ª•c cha</label
                >
                <select class="form-select" id="parentCategory">
                  <option value="">-- Kh√¥ng c√≥ --</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ƒê√≥ng
            </button>
            <button type="submit" form="categoryForm" class="btn btn-primary">
              L∆∞u Danh m·ª•c
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>

    <script>
      let allCategories = [];
      let currentEditId = null;

      /**
       * T·∫£i danh s√°ch danh m·ª•c t·ª´ API v√† hi·ªÉn th·ªã
       */
      async function loadCategories() {
        try {
          const res = await GET("/categories");

          // üö® LOGIC TR√çCH XU·∫§T D·ªÆ LI·ªÜU ƒê·ªòC L·∫¨P (ƒê√É S·ª¨A)
          // N·∫øu API th√†nh c√¥ng (res.success) v√† ch·ª©a m·∫£ng data
          if (res && res.success && Array.isArray(res.data)) {
            allCategories = res.data;
          } else if (Array.isArray(res)) {
            // Tr∆∞·ªùng h·ª£p file api.js c≈© tr·∫£ th·∫≥ng m·∫£ng data
            allCategories = res;
          } else {
            allCategories = [];
            // N√©m l·ªói s·ª≠ d·ª•ng message n·∫øu c√≥
            throw new Error(
              res.message || "D·ªØ li·ªáu danh m·ª•c tr·∫£ v·ªÅ kh√¥ng h·ª£p l·ªá."
            );
          }

          renderCategoryList(allCategories);
          populateParentDropdown(allCategories);
        } catch (error) {
          console.error("L·ªói t·∫£i danh m·ª•c:", error);
          document.getElementById(
            "categoryList"
          ).innerHTML = `<tr><td colspan="5" class="text-center text-danger">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${
            error.message || "L·ªói k·∫øt n·ªëi ho·∫∑c API server"
          }</td></tr>`;
        }
      }

      /**
       * Render danh s√°ch danh m·ª•c v√†o b·∫£ng
       */
      function renderCategoryList(categories) {
        const listBody = document.getElementById("categoryList");

        if (!Array.isArray(categories)) {
          listBody.innerHTML =
            '<tr><td colspan="5" class="text-center text-danger">D·ªØ li·ªáu danh m·ª•c b·ªã l·ªói.</td></tr>';
          return;
        }

        listBody.innerHTML = "";
        if (categories.length === 0) {
          listBody.innerHTML =
            '<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ danh m·ª•c n√†o.</td></tr>';
          return;
        }

        categories.forEach((cat) => {
          const row = listBody.insertRow();
          row.insertCell().textContent = cat._id ? cat._id.slice(-4) : "N/A";
          row.insertCell().textContent = cat.name;
          row.insertCell().textContent = cat.parentCategory
            ? cat.parentCategory.name || cat.parentCategory._id.slice(-4)
            : "---";
          row.insertCell().textContent = cat.description || "";

          const actionsCell = row.insertCell();
          actionsCell.innerHTML = `
            <button class="btn btn-sm btn-warning me-2" onclick="editCategory('${cat._id}')">
              <i class="fas fa-edit"></i> S·ª≠a
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat._id}', '${cat.name}')">
              <i class="fas fa-trash-alt"></i> X√≥a
            </button>
          `;
        });
      }

      /**
       * ƒêi·ªÅn d·ªØ li·ªáu danh m·ª•c v√†o dropdown ch·ªçn Danh m·ª•c cha
       */
      function populateParentDropdown(categories) {
        const select = document.getElementById("parentCategory");
        select
          .querySelectorAll('option:not([value=""])')
          .forEach((opt) => opt.remove());

        categories.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat._id;
          option.textContent = cat.name;
          select.appendChild(option);
        });
      }

      /**
       * Hi·ªÉn th·ªã modal ƒë·ªÉ s·ª≠a danh m·ª•c
       */
      function editCategory(id) {
        const cat = allCategories.find((c) => c._id === id);
        if (!cat) return;

        currentEditId = id;
        document.getElementById(
          "categoryModalLabel"
        ).textContent = `S·ª≠a Danh m·ª•c: ${cat.name}`;
        document.getElementById("name").value = cat.name;
        document.getElementById("description").value = cat.description || "";
        document.getElementById("imageURL").value = cat.imageURL || "";

        const parentId =
          cat.parentCategory && cat.parentCategory._id
            ? cat.parentCategory._id
            : "";
        document.getElementById("parentCategory").value = parentId;

        const modal = new bootstrap.Modal(
          document.getElementById("categoryModal")
        );
        modal.show();
      }

      /**
       * ƒê·∫∑t l·∫°i form v√† tr·∫°ng th√°i s·ª≠a
       */
      function resetForm() {
        currentEditId = null;
        document.getElementById("categoryModalLabel").textContent =
          "T·∫°o Danh m·ª•c m·ªõi";
        document.getElementById("categoryForm").reset();
      }

      /**
       * X√≥a danh m·ª•c
       */
      async function deleteCategory(id, name) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a danh m·ª•c "${name}"?`)) return;

        try {
          const res = await DELETE(`/categories/${id}`);
          alert(res.message);
          loadCategories();
        } catch (error) {
          alert(
            "L·ªói x√≥a: " +
              (error.message ||
                "Danh m·ª•c c√≥ th·ªÉ ƒëang ch·ª©a s·∫£n ph·∫©m ho·∫∑c l·ªói k·∫øt n·ªëi.")
          );
        }
      }

      /**
       * Th√™m listeners cho form (ƒë∆∞·ª£c g·ªçi sau DOMContentLoaded)
       */
      function initializeListeners() {
        const categoryForm = document.getElementById("categoryForm");

        if (!categoryForm) {
          console.error("Kh√¥ng t√¨m th·∫•y form#categoryForm.");
          return;
        }

        categoryForm.addEventListener("submit", async function (event) {
          event.preventDefault();

          const name = document.getElementById("name").value;
          const description = document.getElementById("description").value;
          const imageURL = document.getElementById("imageURL").value;
          const parentCategory =
            document.getElementById("parentCategory").value || null;

          const data = { name, description, imageURL, parentCategory };
          let res;

          try {
            if (currentEditId) {
              // Ch·ª©c nƒÉng S·ª≠a (PUT)
              res = await PUT(`/categories/${currentEditId}`, data);
              alert(res.message || "C·∫≠p nh·∫≠t danh m·ª•c th√†nh c√¥ng!");
            } else {
              // Ch·ª©c nƒÉng Th√™m m·ªõi (POST)
              res = await POST("/categories", data);
              alert(res.message || "T·∫°o danh m·ª•c th√†nh c√¥ng!");
            }

            // ƒê√≥ng modal v√† t·∫£i l·∫°i
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("categoryModal")
            );
            if (modal) modal.hide();

            resetForm();
            loadCategories();
          } catch (error) {
            alert(
              "L·ªói: " + (error.message || "Kh√¥ng th·ªÉ th·ª±c hi·ªán h√†nh ƒë·ªông.")
            );
          }
        });
      }

      // Kh·ªüi t·∫°o: ƒê·∫£m b·∫£o m·ªçi th·ª© ch·∫°y sau khi DOM ƒë√£ t·∫£i xong
      document.addEventListener("DOMContentLoaded", () => {
        loadCategories();
        initializeListeners();
      });
    </script>
  </body>
</html>
