<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quản lý Sản phẩm - Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" id="navbar"></nav>
    <div class="container my-5">
      <h2>Quản lý Sản phẩm</h2>
      <button
        class="btn btn-success mb-3"
        data-bs-toggle="modal"
        data-bs-target="#productModal"
      >
        Thêm sản phẩm
      </button>
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tên</th>
            <th>Giá</th>
            <th>Kho</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody id="productTable"></tbody>
      </table>
    </div>

    <div class="modal fade" id="productModal">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="modalTitle">Thêm sản phẩm</h5>
          </div>
          <div class="modal-body">
            <form id="productForm">
              <input type="hidden" id="productId" />
              <input
                type="text"
                class="form-control mb-2"
                id="name"
                placeholder="Tên"
                required
              />
              <textarea
                class="form-control mb-2"
                id="description"
                placeholder="Mô tả"
              ></textarea>
              <input
                type="number"
                class="form-control mb-2"
                id="price"
                placeholder="Giá"
                required
              />
              <input
                type="number"
                class="form-control mb-2"
                id="stock"
                placeholder="Kho"
                required
              />
              <select class="form-control mb-2" id="category"></select>
              <input
                type="file"
                class="form-control mb-2"
                id="images"
                multiple
                accept="image/*"
              />
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveProduct()">Lưu</button>
          </div>
        </div>
      </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
      if (getRole() !== "ADMIN") {
        alert("Không có quyền!");
        window.location.href = "/";
      }

      // Giả định hàm UPLOAD_SINGLE có sẵn từ file JS khác
      // Chú ý: Bạn cần đảm bảo hàm UPLOAD_SINGLE đã được định nghĩa và import.

      async function loadProducts() {
        const products = await GET("/products");
        const categories = await GET("/categories");
        document.getElementById("productTable").innerHTML = products
          .map(
            (p) => `
        <tr>
          <td>${p._id}</td>
          <td>${p.name}</td>
          <td>${p.price.toLocaleString()}đ</td>
          <td>${p.stock}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editProduct('${
              p._id
            }')">Sửa</button>
            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${
              p._id
            }')">Xóa</button>
          </td>
        </tr>
      `
          )
          .join("");

        const select = document.getElementById("category");
        select.innerHTML = categories
          .map((c) => `<option value="${c._id}">${c.name}</option>`)
          .join("");
      }

      async function editProduct(id) {
        const p = await GET(`/products/${id}`);
        document.getElementById("productId").value = p._id;
        document.getElementById("name").value = p.name;
        document.getElementById("description").value = p.description;
        document.getElementById("price").value = p.price;
        document.getElementById("stock").value = p.stock;
        document.getElementById("category").value = p.category._id;
        new bootstrap.Modal(document.getElementById("productModal")).show();
      }

      async function saveProduct() {
        const id = document.getElementById("productId").value;
        const body = {
          name: document.getElementById("name").value,
          description: document.getElementById("description").value,
          price: parseFloat(document.getElementById("price").value),
          stock: parseInt(document.getElementById("stock").value),
          category: document.getElementById("category").value,
          images: [], // Khởi tạo mảng ảnh
        };

        // 1. Nếu là UPDATE, giữ lại ảnh cũ
        if (id) {
          const existingProduct = await GET(`/products/${id}`);
          body.images = existingProduct.images || [];
        }

        // 2. Upload và thêm ảnh mới
        const files = document.getElementById("images").files;
        if (files.length > 0 && typeof UPLOAD_SINGLE === "function") {
          for (let file of files) {
            const formData = new FormData();
            formData.append("file", file);
            // 🎯 Giả định UPLOAD_SINGLE được định nghĩa trong file khác
            const res = await UPLOAD_SINGLE(formData);
            body.images.push(res.path);
          }
        }

        // 3. Thực hiện PUT hoặc POST
        try {
          id
            ? await PUT(`/products/${id}`, body)
            : await POST("/products", body);
          bootstrap.Modal.getInstance(
            document.getElementById("productModal")
          ).hide();
          loadProducts();
        } catch (err) {
          alert("Lỗi: " + err.message);
        }
      }

      async function deleteProduct(id) {
        if (confirm("Xóa sản phẩm?")) {
          await DEL(`/products/${id}`);
          loadProducts();
        }
      }

      loadProducts();
    </script>
  </body>
</html>
